Genvex / Micro Nabto Protocol Findings
======================================

Connection Details:
-------------------
- Protocol: UDP
- Port: 5570
- Local Communication: Unencrypted (mostly), but wrapped in "Crypto" payloads with code 0x000a (or 0x0003 for KeepAlive).

Packet Structure:
-----------------
Header (16 bytes):
- Client ID (4 bytes): Randomly generated by client.
- Server ID (4 bytes): Initially 0x00000000, then provided by server in U_CONNECT response.
- Packet Type (1 byte): 
  - 0x83: U_CONNECT
  - 0x16: U_DATA
- Version (1 byte): 0x02
- Retransmission Count (1 byte): 0x00
- Flags (1 byte): 0x00 (0x40 for KeepAlive?)
- Sequence ID (2 bytes): Incremental.
- Packet Length (2 bytes): Total length including header.

Payloads:
---------
Payloads follow the header.
Structure:
- Type (1 byte)
- Flags (1 byte)
- Length (2 bytes): Length of payload content (including header overhead in some cases).
- Content (Variable)

Payload Types:
- 0x35 (U_IPX): Network info. Used in U_CONNECT.
- 0x3F (U_CP_ID): Client ID / Email. Used in U_CONNECT.
- 0x36 (U_CRYPT): Encrypted/Wrapped data. Used for commands.
- 0x34 (U_NOTIFY?): Often received before the actual response. Contains 0x00000003.

U_CRYPT Payload:
- Header: Type(36) + Flags(00) + Length(2)
- Content: CryptoCode(2) + Data + Padding(1)
- CryptoCode: 0x000a for commands, 0x0003 for KeepAlive?
- Padding: 0x02 at the end.

Checksum:
---------
- Appended at the very end of the packet (after all payloads).
- 2 bytes.
- Calculation: Sum of all bytes in the packet (excluding the checksum bytes themselves) & 0xFFFF.
- Required if U_CRYPT payload is present.

Commands (Wrapped in U_CRYPT):
------------------------------
PING:
- Command Code: 0x00000011
- Data: "ping" (ASCII)
- Total Data: 00 00 00 11 70 69 6e 67

DATAPOINT_READ:
- Command Code: 0x0000002d
- Count (2 bytes): Number of datapoints.
- Items:
  - Object (1 byte): Usually 0.
  - Address (4 bytes): Datapoint address.
- Terminator: 0x01

Device Discovery:
-----------------
- IP: 192.168.0.178
- Device Number: 79265
- Device Model: 2010 (Optima 270?)
- Slave Device Model: 13

Observations:
-------------
- The device often responds with a U_NOTIFY (Type 0x34) packet before sending the actual U_CRYPT response.
- A retry/loop mechanism is needed to consume these notifications and wait for the actual data.
- Sequence numbers must be managed.

Datapoint Observations (Optima 270 / Model 2010):
-------------------------------------------------
Fan Speed:
- Read Address: 7
- Write Address: 24
- Value Mapping:
  - 0 = Speed 1 (App shows "Speed 1", Duty Cycle ~30%)
  - 1 = Speed 2 (Presumed)
  - 2 = Speed 3 (Presumed)
  - 3 = Speed 4 (Presumed)
  - 4 = Off? (Or maybe 0 is Off and 1 is Speed 1? Need to verify. Current finding: 0 = Speed 1)

Other Fan Datapoints:
- Duty Cycle Supply: Addr 18 (Divider 100)
- Duty Cycle Extract: Addr 19 (Divider 100)
- RPM Supply: Addr 35
- RPM Extract: Addr 36


